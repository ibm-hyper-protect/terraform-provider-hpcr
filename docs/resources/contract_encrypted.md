---
# generated by https://github.com/hashicorp/terraform-plugin-docs
page_title: "hpcr_contract_encrypted Resource - hpcr"
subcategory: ""
description: |-
  Generates an encrypted and signed user data field from an HPCR contract using the contract-go library.
---

# hpcr_contract_encrypted (Resource)

Generates an encrypted and signed `user_data` field from an HPCR contract. This resource uses the [contract-go library](https://ibm-hyper-protect.github.io/contract-go)'s `HpcrContractSignedEncrypted()` function to:

1. Encrypt the workload and environment sections separately using the platform's encryption certificate
2. Sign the encrypted contract with an RSA private key for integrity verification
3. Produce a base64-encoded output suitable for use as `user_data` in IBM Hyper Protect Virtual Servers

## How It Works

The contract encryption process follows these steps:

1. **Input Validation**: The YAML contract is validated for correct structure
2. **Encryption**: Each section (workload, environment) is encrypted using OpenSSL with the platform-specific certificate
3. **Signing**: The encrypted contract is signed using an RSA private key (auto-generated if not provided)
4. **Encoding**: The final output is base64-encoded in the format: `hyper-protect-basic.<password>.<encrypted-data>`
5. **Checksums**: SHA256 checksums are computed for both input and output for integrity verification

## Example Usage

```terraform
# Get the encryption certificate for your region
data "hpcr_encryption_cert" "cert" {
  region = "us-south"
}

# Create encrypted workload section
resource "hpcr_text_encrypted" "workload" {
  text = yamlencode({
    "compose" : {
      "archive" : resource.hpcr_tgz.compose.rendered
    }
  })
}

# Create encrypted environment section
resource "hpcr_text_encrypted" "env" {
  text = yamlencode({
    "type" : "env",
    "logging" : {
      "syslog" : {
        "hostname" : "example.com",
        "port" : 514
      }
    }
  })
}

# Generate the final encrypted contract
resource "hpcr_contract_encrypted" "contract" {
  contract = yamlencode({
    "workload" : resource.hpcr_text_encrypted.workload.rendered,
    "env" : resource.hpcr_text_encrypted.env.rendered
  })
  cert = data.hpcr_encryption_cert.cert.cert
  # platform defaults to "hpvs"
  # privkey is auto-generated if not provided
}

# Use the rendered contract as user_data
output "user_data" {
  value     = resource.hpcr_contract_encrypted.contract.rendered
  sensitive = true
}

# Access the checksums for verification
output "contract_checksum" {
  value = resource.hpcr_contract_encrypted.contract.sha256_out
}
```

## Example with Custom Signing Key

```terraform
# Generate or provide your own signing key
resource "tls_private_key" "signing_key" {
  algorithm = "RSA"
  rsa_bits  = 4096
}

resource "hpcr_contract_encrypted" "contract" {
  contract = yamlencode({
    "workload" : resource.hpcr_text_encrypted.workload.rendered,
    "env" : resource.hpcr_text_encrypted.env.rendered
  })
  cert    = data.hpcr_encryption_cert.cert.cert
  privkey = tls_private_key.signing_key.private_key_pem
}
```

<!-- schema generated by tfplugindocs -->
## Schema

### Required

- `cert` (String) Certificate used to encrypt the contract, in PEM format. Defaults to the latest HPCR image certificate if not specified.
- `contract` (String, Sensitive) YAML serialization of the contract

### Optional

- `platform` (String) Hyper Protect platform where this contract will be deployed. Defaults to hpvs
- `privkey` (String, Sensitive) Private key used to sign the contract. If omitted, a temporary signing key is created.

### Read-Only

- `id` (String) Resource identifier
- `rendered` (String) Rendered output of the resource
- `sha256_in` (String) SHA256 of the input
- `sha256_out` (String) SHA256 of the output
